

resource "azurerm_private_dns_zone_virtual_network_link" "private_link_to_hub" {
  name                  = "hub"
  resource_group_name   = azurerm_kubernetes_cluster.aks.node_resource_group
  private_dns_zone_name = azprivatedns_zones.current.dns_zones.0.name
  virtual_network_id    = azurerm_virtual_network.hub.id
}

# az network vnet subnet update --route-table $DEPLOYMENT_NAME --ids $KUBE_AGENT_SUBNET_ID
resource "azurerm_subnet_route_table_association" "aks" {
  subnet_id      = azurerm_subnet.agents.id
  route_table_id = azurerm_route_table.aks.id
}

# az network route-table route create --resource-group $VNET_GROUP --name $DEPLOYMENT_NAME --route-table-name $DEPLOYMENT_NAME --address-prefix 0.0.0.0/0 --next-hop-type VirtualAppliance --next-hop-ip-address $FW_PRIVATE_IP --subscription $SUBSCRIPTION_ID
resource "azurerm_route" "aks_traffic_to_hub" {
  address_prefix         = "0.0.0.0/0"
  name                   = "traffic_to_hub"
  next_hop_in_ip_address = azurerm_firewall.fw.ip_configuration.0.private_ip_address
  next_hop_type          = "VirtualAppliance"
  resource_group_name    = var.resource_group.name
  route_table_name       = azurerm_route_table.aks.name
}


# KUBE_AGENT_SUBNET_ID="/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$VNET_GROUP/providers/Microsoft.Network/virtualNetworks/$KUBE_VNET_NAME/subnets/$KUBE_AGENT_SUBNET_NAME"
# az network route-table create -g $VNET_GROUP --name $DEPLOYMENT_NAME
resource "azurerm_route_table" "aks" {
  location            = var.resource_group.location
  name                = "rt-${local.instance_id}"
  resource_group_name = var.resource_group.name
  tags                = var.resource_group.tags
}



